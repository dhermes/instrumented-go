# instrumented-go

> A Small Experiment Showcasing a `main` Binary Instrumented for Coverage

## Usage

```
$ make
Makefile for `instrumented-go` project

Usage:
   make instrumented-main    Make a custom `main` binary that is instrumented for coverage
   make cover.out            Generate a cover profile for code paths invoked by `cmd/main.go`
   make coverage.html        Generate HTML for the `cmd/main.go` cover profile
   make clean                Remove all generated files

```

## Generated Files

-   `coverage.html` is just the HTML coverage report generated by
    `make coverage.html`
-   `coverage/${SHA}.out` contains the `cover.out` files generated for "most"
    commits; these are checked in via special "metadata" commits and are
    normalized first by ordering names alphabetically and then by line
    numbers
-   `porcelain/${SHA}.json` contains the output of `git blame --porcelain` for
    each filename mentioned in the corresponding `coverage/${SHA}.out`. These
    files (for now) assume the blame output will be UTF-8 encoded and then uses
    a map from filename to lines (`\n`-delimited) in the blame output

## References

-   [Accurate Code Coverage in Go][1]
-   [The cover story][2]
-   [Measuring Code Coverage of Golang Binaries with Bincover][3]
-   `bincover` [repository][4]
-   Data [encoding][5] in `cover.out` files
    ```
    `name.go:line.column,line.column numberOfStatements count`
    ```
-   `git blame --porcelain` [format][6]

[1]: https://www.ory.sh/golang-go-code-coverage-accurate/
[2]: https://blog.golang.org/cover
[3]: https://www.confluent.io/blog/measure-go-code-coverage-with-bincover/
[4]: https://github.com/confluentinc/bincover
[5]: https://github.com/golang/go/blob/go1.15.6/src/cmd/cover/profile.go#L56
[6]: https://git-scm.com/docs/git-blame#_the_porcelain_format
